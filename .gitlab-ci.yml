before_script:
  - export PATH=$PATH:/root/.nvm/versions/node/v14.18.3/bin
  - export PATH=$PATH:/usr/local/bin

stages:
  - pre-install
  - install
  - lint
  - build
  - deploy

cache:
  paths:
    - node_modules/
    - dist/

pre-install:
  stage: pre-install
  only:
    changes:
      - package.json
  script:
    - echo "package.json has changed,start installğŸ”¥ğŸ”¥ğŸ”¥"
    - npm install
    - echo "finish installğŸ”¥ğŸ”¥ğŸ”¥"

install:
  stage: install
  script:
    - echo "start installğŸ”¥ğŸ”¥ğŸ”¥"
    - - if [ ! -d "./node_modules/" ];then npm install;else echo "node_modules exists, skip this step"; fi
    - echo "finish installğŸ”¥ğŸ”¥ğŸ”¥"

lint:
  stage: lint
  script:
    - echo "start lintğŸš¬ğŸš¬ğŸš¬"
    - npm run eslint
    - npm run stylelint
    - echo "finish lintğŸš¬ğŸš¬ğŸš¬"

build:
  stage: build
  only:
    refs:
      - main
  script:
    - echo "start buildğŸ’ªğŸ’ªğŸ’ª"
    - npm run build
    - echo "finish buildğŸ’ªğŸ’ªğŸ’ª"

deploy:
  stage: deploy
  only:
    refs:
      - main
  script:
    - echo "deploy to serverâœ¨âœ¨âœ¨"
    - ssh -i user.key root@qiuqian.xyz "rm -rf /home/depolyed/fjsp-vision/dist"
    - scp -prq ./dist/. root@qiuqian.xyz:/home/depolyed/fjsp-vision/dist
    - echo "well done~~ğŸ‘ğŸ‘ğŸ‘"